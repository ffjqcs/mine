<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加载中</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <style>
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        .loading-text {
            margin-bottom: 10px;
        }
        .error-message {
            color: red;
            margin: 10px 0;
            max-width: 80%;
            word-break: break-word;
        }
        .action-button {
            margin-top: 20px;
            padding: 8px 16px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .action-button:hover {
            background: #66b1ff;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div v-if="!errorMessage" class="loading-text">正在加载，请稍候...</div>
            <div v-if="errorMessage" class="error-message">{{ errorMessage }}</div>
            <button v-if="errorMessage" class="action-button" @click="goToHomePage">返回首页</button>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                params: {},
                errorMessage: '',
                apiResponse: null
            },
            mounted() {
                this.parseUrlParams();
                console.log('获取到的所有URL参数:', this.params);
                
                if (!this.params.id) {
                    this.errorMessage = '缺少必要参数: id';
                    return;
                }
                this.fetchData();
            },
            methods: {
                parseUrlParams() {
                    const urlParams = new URLSearchParams(window.location.search);
                    urlParams.forEach((value, key) => {
                        this.params[key] = value;
                    });
                },
                goToHomePage() {
                    window.location.href = './index.html';
                },
                async fetchData() {
                    try {
                        const apiUrl = `https://beiying.grkx.cn/group/index/apiShare?id=${this.params.id}`;
                        console.log('正在请求API:', apiUrl);
                        
                        const response = await fetch(apiUrl);
                        const res = await response.json();
                        this.apiResponse = res;
                        
                        console.log('API响应数据:', res);
                        
                        // 修改后的数据验证逻辑
                        if (!res || !res.wxgroup) {
                            throw new Error('请求失败: 响应数据无效');
                        }
                        
                        const responseData = res; // 直接使用res而不是res.data
                        let targetPage = '';
                        switch (responseData.wxgroup.wxg_type) {
                            case 1: targetPage = './wxg/share.html'; break;
                            case 2: targetPage = './wxg/share_img.html'; break;
                            case 3: targetPage = './wxg/share_gmb.html'; break;
                            case 5: targetPage = './wxg/share_shp.html'; break;
                            default:
                                this.errorMessage = `未知的分享类型: ${responseData.wxgroup.wxg_type}`;
                                return;
                        }
                        
                        console.log('准备跳转到:', targetPage);
                        this.navigateWithData(targetPage, responseData);
                        
                    } catch (error) {
                        this.errorMessage = `加载失败: ${error.message}`;
                        console.error('错误详情:', error);
                    }
                },
                navigateWithData(targetPage, responseData) {
                    const storageKey = 'shareData_' + Date.now();
                    localStorage.setItem(storageKey, JSON.stringify(responseData));
                    console.log('存储数据到localStorage, key:', storageKey);
                    window.location.href = `${targetPage}?storageKey=${storageKey}`;
                }
            }
        });
    </script>
</body>
</html>
